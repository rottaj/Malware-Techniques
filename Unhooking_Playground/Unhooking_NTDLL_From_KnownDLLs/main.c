//
// Created by j4ck on 2/24/24.
//
#include <windows.h>
#include <wchar.h>
#include <stdio.h>
#include <ntdef.h>

#define NTDLL	L"\\KnownDlls\\ntdll.dll"

typedef NTSTATUS (NTAPI* fnNtOpenSection) (
    PHANDLE             SectionHandle,
    ACCESS_MASK         DesiredAccess,
    POBJECT_ATTRIBUTES  ObjectAttributes
    );

int wmain() {

    OBJECT_ATTRIBUTES objAtr        = { 0 };
    UNICODE_STRING    unicodeString = { 0 };
    PVOID pBuffer = 0;
    HANDLE hSection;


    unicodeString.Buffer = (PWSTR)NTDLL;
    unicodeString.Length = wcslen(NTDLL) * sizeof(WCHAR);
    unicodeString.MaximumLength = unicodeString.Length + sizeof(WCHAR);

    InitializeObjectAttributes(&objAtr, &unicodeString, OBJ_CASE_INSENSITIVE, NULL, NULL);

    fnNtOpenSection pNtOpenSection = (fnNtOpenSection)GetProcAddress(GetModuleHandleW(L"NTDLL"), "NtOpenSection");

    NTSTATUS status = pNtOpenSection(&hSection, SECTION_MAP_READ, &objAtr);
    if (status != 0x00) {
        printf("[!] NtOpenSection Failed With Error : 0x%0.8X \n", status);
        return -1;
    }

    pBuffer = MapViewOfFile(hSection, FILE_MAP_READ, 0, 0, 0);
    if (MapViewOfFile == NULL) {
        wprintf(L"[!] MapViewOfFile Failed %d\n", GetLastError());
        return -1;
    }


    wprintf(L"Testing %p", pBuffer);

    // Include SWAP NTDLL's here. (Refer to previous page www.rotta.rocks)
    getchar();
    return 0;
}
