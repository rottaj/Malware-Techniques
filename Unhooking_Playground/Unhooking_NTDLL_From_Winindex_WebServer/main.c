//
// Created by j4ck on 2/29/24.
//
#include <windows.h>
#include <wchar.h>
#include <stdio.h>
#include <wininet.h>
#include <winternl.h>

#define BASE_URL L"https://msdl.microsoft.com/download/symbols/ntdll.dll/"


PVOID FetchLocalNtdllAddress() {
    PPEB pPeb = (PPEB)__readgsqword(0x60);
    PLDR_DATA_TABLE_ENTRY pLdr = (PLDR_DATA_TABLE_ENTRY)((PBYTE)pPeb->Ldr->InMemoryOrderModuleList.Flink->Flink - 0x10);
    return pLdr->DllBase;
}

// Parses PE Headers & returns OptionalHeader->SizeOfImage & NtHeader->FileHeader->TimeStamp
BOOL ParseLocalNtdllHeaders(PVOID pNtdllBaseAddress, PDWORD pdwSizeOfImage, PDWORD pdwTimeStamp) {
    PIMAGE_DOS_HEADER pDosHeader = (PIMAGE_DOS_HEADER)pNtdllBaseAddress;
    if (pDosHeader->e_magic != IMAGE_DOS_SIGNATURE) {
        wprintf(L"[!] DOS Signature Failed");
        return FALSE;
    }
    PIMAGE_NT_HEADERS pNtHeaders = (PIMAGE_NT_HEADERS)(pNtdllBaseAddress + pDosHeader->e_lfanew);
    if (pNtHeaders->Signature != IMAGE_NT_SIGNATURE) {
        wprintf(L"[!] NT Signature Failed");
        return FALSE;
    }
    *pdwTimeStamp = pNtHeaders->FileHeader.TimeDateStamp;
    *pdwSizeOfImage = pNtHeaders->OptionalHeader.SizeOfImage;
    return TRUE;
}

PVOID GetNTDLLFromWinIndex(LPWSTR pwUrl) {

    /*
     * #TODO Wininit InternetOpenW not working
     *      * #TODO Wininit InternetOpenW not working
     *           * #TODO Wininit InternetOpenW not working
     *                * #TODO Wininit InternetOpenW not working
     */
    HINTERNET hInternet = NULL;
    HINTERNET hInternetFile = NULL;
    hInternet = InternetOpenW(L"Example", INTERNET_OPEN_TYPE_DIRECT, NULL, NULL, 0);
    if (hInternet == NULL) {
        wprintf(L"[!] InternetOpenW Failed With Error : %d \n", GetLastError());
        //return NULL;
    }
    wprintf(L"Loaded hInternet");
    // Opening the handle to the ntdll file using theURL
    hInternetFile = InternetOpenUrlW(hInternet, pwUrl, NULL, 0, INTERNET_FLAG_HYPERLINK | INTERNET_FLAG_IGNORE_CERT_DATE_INVALID, 0);
    if (hInternetFile == NULL) {
        wprintf(L"[!] InternetOpenUrlW Failed With Error : %d \n", GetLastError());
        //return NULL;
    }

}


int wmain() {
    PVOID pNtdllBaseAddress = FetchLocalNtdllAddress();
    DWORD dwSizeOfImage = 0;
    DWORD dwTimeStamp = 0;

    ParseLocalNtdllHeaders(pNtdllBaseAddress, &dwSizeOfImage, &dwTimeStamp);
    wprintf(L"[+] TimeStamp: %x\n[+] SizeOfImage: %x\n", dwTimeStamp, dwSizeOfImage);

    LPWSTR pwUrl;
    wsprintfW(pwUrl, L"%s%X%X/ntdll.dll", BASE_URL, dwTimeStamp, dwSizeOfImage);
    GetNTDLLFromWinIndex(pwUrl);
    return 0;
}
