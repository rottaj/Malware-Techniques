//
// Created by j4ck on 2/1/24.
//
#include <stdio.h>
#include <windows.h>



// Declare global variables to hold syscall numbers and syscall instruction addresses
DWORD wNtAllocateVirtualMemory;
UINT_PTR sysAddrNtAllocateVirtualMemory;
DWORD wNtWriteVirtualMemory;
UINT_PTR sysAddrNtWriteVirtualMemory;
DWORD wNtCreateThreadEx;
UINT_PTR sysAddrNtCreateThreadEx;
DWORD wNtWaitForSingleObject;
UINT_PTR sysAddrNtWaitForSingleObject;


int wmain() {

    HANDLE hNtdll;

    UINT_PTR pNtAllocateVirtualMemory;
    hNtdll = GetModuleHandleW(L"ntdll.dll");
    if (hNtdll == NULL) {
        wprintf(L"[!] GetModuleHandleW Failed to load NTDLL.DLL GetLastError : %d \n", GetLastError());
        return -1;
    }

    // Declare and initialize a pointer to the NtAllocateVirtualMemory function and get the address of the NtAllocateVirtualMemory function in the ntdll.dll module
    pNtAllocateVirtualMemory = (UINT_PTR)GetProcAddress(hNtdll, "NtAllocateVirtualMemory");
    // Read the syscall number from the NtAllocateVirtualMemory function in ntdll.dll
    // This is typically located at the 4th byte of the function
    wNtAllocateVirtualMemory = ((unsigned char*)(pNtAllocateVirtualMemory + 4))[0];

    // The syscall stub (actual system call instruction) is some bytes further into the function.
    // In this case, it's assumed to be 0x12 (18 in decimal) bytes from the start of the function.
    // So we add 0x12 to the function's address to get the address of the system call instruction.
    sysAddrNtAllocateVirtualMemory = pNtAllocateVirtualMemory + 0x12;

    wprintf(L"pNtAllocateVirtualMemory %p\n", pNtAllocateVirtualMemory) ;
    wprintf(L"pNtAllocateVirtualMemory %d\n", wNtAllocateVirtualMemory) ;
    wprintf(L"sysAddrNtAllocateVirtualMemory %p\n", sysAddrNtAllocateVirtualMemory);



    WaitForSingleObject((HANDLE)-1, INFINITE);

    return 0;
}