//
// Created by j4ck on 1/25/24.
//

#include <stdio.h>
#include <windows.h>
#include <wchar.h>
#include <time.h>

#define TMPFILE L"hammereed.tmp"

BOOL ApiHammering(DWORD dwStress) { // dwStress is number of cycles to complete before execution starts.
    // Loops through dwStress


    WCHAR     szPath                  [MAX_PATH * 2],
            szTmpPath               [MAX_PATH];
    HANDLE    hRFile                  = INVALID_HANDLE_VALUE, // Read Handle
            hWFile                  = INVALID_HANDLE_VALUE; // Write Handle

    PBYTE   pRandBuffer               = NULL;
    SIZE_T  sBufferSize               = 0xFFFFF;	// 1048575 byte

    INT     Random                    = 0;

    // Getting the tmp folder path
    if (!GetTempPathW(MAX_PATH, szTmpPath)) {
        printf("[!] GetTempPathW Failed With Error : %d \n", GetLastError());
        return FALSE;
    }

    // Constructing the file path
    // For some reason wcscat_s doesn't work. Fucking Windows.
    wsprintfW(szPath, L"%s%s", szTmpPath, TMPFILE);
    //wcscat_s(szTmpPath, MAX_PATH, TMPFILE);

    wprintf(L"%ls\n", szPath);

    for (SIZE_T i = 0; i < dwStress; i++){

        // Creating the file in write mode
        if ((hWFile = CreateFileW(szPath, GENERIC_WRITE, 0, NULL, CREATE_ALWAYS, FILE_ATTRIBUTE_TEMPORARY, NULL)) == INVALID_HANDLE_VALUE) {
            printf("[!] CreateFileW Failed With Error : %d \n", GetLastError());
            return FALSE;
        }

        // Allocate Buffer
        pRandBuffer = HeapAlloc(
                GetProcessHeap(),
                HEAP_ZERO_MEMORY,
                sBufferSize
                );

        wprintf(L"Allocated Heap: %p\n", pRandBuffer);

        // Generate a random number between 0 and RAND_MAX && Set Memory Buffer to that number
        Random = rand() % 0xFF;
        memset(pRandBuffer, Random, sBufferSize);

        // Write to File


        // Cleanup Write Handle
        CloseHandle(hWFile);
        // Read Memory

        getchar();

        if ((hRFile = CreateFileW(szPath, GENERIC_READ, 0, NULL, OPEN_EXISTING, FILE_ATTRIBUTE_TEMPORARY | FILE_FLAG_DELETE_ON_CLOSE, NULL)) == INVALID_HANDLE_VALUE) {
            wprintf(L"[!] CreateFileW DELETE Failed With Error : %d \n", GetLastError());
            return FALSE;
        }

        // Cleanup
        RtlZeroMemory(pRandBuffer, sBufferSize);
        HeapFree(GetProcessHeap(), 0, pRandBuffer);
        // Close Handle ( Deletes File )
        CloseHandle(hRFile);
        getchar();
    }


    return TRUE;
}


int wmain() {
    DWORD dwStress = 1;
    if (!ApiHammering(dwStress)) {
        return -1;
    }
    wprintf(L"Program Completed");
    return 0;
}