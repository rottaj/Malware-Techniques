//
// Created by j4ck on 2/14/24.
//

#include <windows.h>
#include <wchar.h>
#include <stdio.h>

typedef struct _PE_HDRS
{
    PBYTE                    pFileBuffer;
    DWORD                    dwFileSize;

    PIMAGE_NT_HEADERS        pImgNtHdrs;
    PIMAGE_SECTION_HEADER    pImgSecHdr;

    PIMAGE_DATA_DIRECTORY    pEntryImportDataDir;
    PIMAGE_DATA_DIRECTORY    pEntryBaseRelocDataDir;
    PIMAGE_DATA_DIRECTORY    pEntryTLSDataDir;
    PIMAGE_DATA_DIRECTORY    pEntryExceptionDataDir;
    PIMAGE_DATA_DIRECTORY    pEntryExportDataDir;

    BOOL                     bIsDLLFile;

} PE_HDRS, *PPE_HDRS;


BOOL InitializePeStruct(PPE_HDRS pPe, LPVOID lpBuffer, DWORD dFileSize) {
    pPe->dwFileSize = dFileSize;
    pPe->pFileBuffer = lpBuffer;

    pPe->pImgNtHdrs               = (PIMAGE_NT_HEADERS)(lpBuffer + ((PIMAGE_DOS_HEADER)lpBuffer)->e_lfanew);

    if (pPe->pImgNtHdrs->Signature != IMAGE_NT_SIGNATURE)
        return FALSE;

    pPe->bIsDLLFile               = (pPe->pImgNtHdrs->FileHeader.Characteristics & IMAGE_FILE_DLL) ? TRUE : FALSE;
    pPe->pImgSecHdr               = IMAGE_FIRST_SECTION(pPe->pImgNtHdrs);
    pPe->pEntryImportDataDir      = &pPe->pImgNtHdrs->OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_IMPORT];
    pPe->pEntryBaseRelocDataDir   = &pPe->pImgNtHdrs->OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_BASERELOC];
    pPe->pEntryTLSDataDir         = &pPe->pImgNtHdrs->OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_TLS];
    pPe->pEntryExceptionDataDir   = &pPe->pImgNtHdrs->OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_EXCEPTION];
    pPe->pEntryExportDataDir      = &pPe->pImgNtHdrs->OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_EXPORT];

    return TRUE;
}


BOOL LoadFileIntoBuffer(LPVOID* plpBuffer, DWORD* pdFileSize) {
    HANDLE hFile = NULL;
    // Create File Handle
    hFile = CreateFileW(L"mimikatz.exe",
                        GENERIC_ALL,
                        0,
                        NULL,
                        OPEN_EXISTING,
                        FILE_ATTRIBUTE_NORMAL,
                        NULL
    );
    if (hFile == INVALID_HANDLE_VALUE) {
        wprintf(L"[!] CreateFileW Failed to Open File Handle %d\n", GetLastError());
        return FALSE;
    }

    // Get File Size
    *pdFileSize = GetFileSize(hFile, NULL);
    if (*pdFileSize == INVALID_FILE_SIZE) {
        wprintf(L"[!] GetFileSize Failed %d\n", GetLastError());
        return FALSE;
    }

    wprintf(L"[+] Read Mimikatz File Size: %d\n", *pdFileSize);

    // Allocate Memory for File Contents
    *plpBuffer = HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, *pdFileSize);
    if (*plpBuffer == NULL) {
        wprintf(L"[!] HeapAlloc Failed with Error %d\n", GetLastError());
        return FALSE;
    }

    wprintf(L"[+] Allocated Memory %p\n", *plpBuffer);

    // Read File and Write to Allocated Memory Region (lpBuffer)
    DWORD dBytesWritten = 0;
    if (!ReadFile(hFile, *plpBuffer, *pdFileSize, &dBytesWritten, NULL)) {
        wprintf(L"[!] ReadFile Failed with Error %d\n", GetLastError()) ;
        return FALSE;
    }


    if (hFile) {
        CloseHandle(hFile);
    }
    return TRUE;
}


BOOL LocalPeExec(IN PPE_HDRS pPe){
    PBYTE			pPeBaseAddress			= NULL;

    if ((pPeBaseAddress = VirtualAlloc(NULL, pPe->pImgNtHdrs->OptionalHeader.SizeOfImage, MEM_RESERVE | MEM_COMMIT, PAGE_READWRITE)) == NULL) {
        wprintf(L"[!] VirtualAlloc Failed %d", GetLastError()) ;
        return FALSE;
    }

    for (int i = 0; i < pPe->pImgNtHdrs->FileHeader.NumberOfSections; i++) {
        memcpy(
                (PVOID)(pPeBaseAddress + pPe->pImgSecHdr[i].VirtualAddress),			// Distination: pPeBaseAddress + RVA
                (PVOID)(pPe->pFileBuffer + pPe->pImgSecHdr[i].PointerToRawData),		// Source: pPeHdrs->pFileBuffer + RVA
                pPe->pImgSecHdr[i].SizeOfRawData							// Size
        );
    }


    wprintf(L"BaseAddress %p\n",pPeBaseAddress + pPe->pImgSecHdr[0].VirtualAddress);
    getchar();
}


int wmain() {
    DWORD dFileSize = 0;
    LPVOID lpBuffer = NULL;

    PE_HDRS myPe = { 0 };
    PPE_HDRS pe = &myPe;


    if (!LoadFileIntoBuffer(&lpBuffer, &dFileSize)) {
        return -1;
    }

    wprintf(L"[+] Wrote %d Bytes to Memory %p\n",dFileSize, lpBuffer);

    if (!InitializePeStruct(pe, lpBuffer, dFileSize)) {
        return -1;
    }

    wprintf(L"[+] Testing %d %p\n", pe->dwFileSize, pe->pFileBuffer);


    LocalPeExec(pe);
    getchar();

    return 0;
}
