//
// Created by j4ck on 10/7/23.
// Create Custom Win32 Functions (GetProcAddress & GetModuleHandle)
//
#include <stdio.h>
#include <windows.h>
#include <winternl.h>
#include "syscalls.h"
#include "MagicAPI.h"


NTSTATUS MagicallyOpenProcess(OUT PHANDLE hProcess, IN DWORD PID) {
    NTSTATUS status;

    if (Instance->OpenProcessR == NULL) {
        wprintf(L"Failed to Load NtOpenProcess from Ndll.dll %d\n", GetLastError());
        return status;
    }

    UNICODE_STRING objName = { 0 };
    OBJECT_ATTRIBUTES objAttributes = {sizeof(OBJECT_ATTRIBUTES)};
    //RtlInitUnicodeString(&objName, NULL); // Initialize with NULL

    CLIENT_ID clientId = {(HANDLE)PID, NULL};

    status = Instance->OpenProcessR(hProcess, PROCESS_ALL_ACCESS, &objAttributes, &clientId);

    return status; // return NULL if no Process
}

NTSTATUS MagicallyAllocateVirtualMemoryEx(IN HANDLE hProcess, IN OUT LPVOID lpBuffer, IN OUT PSIZE_T szBufferSize, IN ULONG uAllocationType, IN ULONG uProtect) {
    NTSTATUS status;
    if (Instance->VirtualAllocExR == NULL) {
        wprintf(L"MagicallyAllocateVirtualMemoryEx Failed to Load NtAllocateVirtualMemory From Ntdll.dll %d\n", GetLastError());
        return status;
    }

    status = Instance->VirtualAllocExR(hProcess, lpBuffer, 0, szBufferSize, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);

    return status;
}

NTSTATUS MagicallyProtectVirtualMemoryEx(IN HANDLE hProcess, IN OUT PVOID pBaseAddress, IN OUT PULONG puNumberOfBytesToProtect, IN ULONG puNewAccessProtection, OUT PULONG puOldAccessProtection) {
    NTSTATUS status;
    if (Instance->VirtualProtectExR == NULL) {
        wprintf(L"MagicallyProtectVirtualMemoryEx Failed to Load NtProtectVirtualMemory From Ntdll.dll %d\n", GetLastError());
        return status;
    }
    status = Instance->VirtualProtectExR(hProcess, pBaseAddress, puNumberOfBytesToProtect, puNewAccessProtection, puNumberOfBytesToProtect);

    return status;
}


NTSTATUS MagicallyWriteProcessMemory(IN HANDLE hProcess, IN PVOID pBaseAddress, IN PVOID pBuffer, ULONG uNumberOfBytesToWrite, PULONG puNumberOfBytesWritten) {
    NTSTATUS status;
    if (Instance->WriteVirtualMemory == NULL) {
        wprintf(L"MagicallyWriteProcessMemory Failed to Load NtWriteVirtualMemory From Ntdll.dll %d\n", GetLastError());
        return status;
    }
    status = Instance->WriteVirtualMemory(hProcess, pBaseAddress, pBuffer, uNumberOfBytesToWrite, puNumberOfBytesWritten);
    return status;
}


NTSTATUS MagicallyCreateThread(OUT PHANDLE pThread, IN ACCESS_MASK desiredAccess, IN OPTIONAL POBJECT_ATTRIBUTES pObjectAttributes, IN HANDLE hProcess, IN PVOID StartRoutine, IN PVOID Argument, IN ULONG CreateFlags, IN SIZE_T ZeroBits, IN SIZE_T StackSize, IN SIZE_T MaximumStackSize, IN PVOID AttributeList) {
    NTSTATUS status;
    if (Instance->CreateThread == NULL) {
        wprintf(L"MagicallyCreateThread Failed to Load NtCreateThread From Ntdll.dll %d\n", GetLastError());
        return status;
    }
    status = Instance->CreateThread(pThread, desiredAccess, pObjectAttributes, hProcess, StartRoutine, Argument, CreateFlags, ZeroBits, StackSize, MaximumStackSize, AttributeList);
    return status;
}

