#include <stdio.h>
#include <wchar.h>
#include <windows.h>
#include <winternl.h>
#include <syscalls.h>

typedef struct {
    NtOpenProcess OpenProcessR;
    NtAllocateVirtualMemory VirtualAllocR;
} INSTANCE, *PINSTANCE;


INSTANCE Instance       = { 0 }; // Define Global Instance

NTSTATUS MagicallyOpenProcessW(HANDLE hProcess, DWORD PID) {
    NTSTATUS status;

    if (Instance.OpenProcessR == NULL) {
        wprintf(L"Failed to Load NtOpenProcess %d", GetLastError());
        return status;
    }

    UNICODE_STRING objName = { 0 };
    OBJECT_ATTRIBUTES objAttributes = {sizeof(OBJECT_ATTRIBUTES)};
    //RtlInitUnicodeString(&objName, NULL); // Initialize with NULL

    CLIENT_ID clientId = {(HANDLE)PID, NULL};

    status = Instance.OpenProcessR(hProcess, PROCESS_ALL_ACCESS, &objAttributes, &clientId);

    return status; // return NULL if no Process
}


int wmain(int argc, wchar_t* argv[]) {
    Instance.OpenProcessR = (NtOpenProcess) GetProcAddress(GetModuleHandleW(L"NTDLL.DLL"), "NtOpenProcess");

    HANDLE hProcess = NULL;

    if (argc < 2) {
        wprintf(L"Insufficient Parameters Passed to Main");
        return -1;
    }
    DWORD PID = _wtoi(argv[1]);
    NTSTATUS status = MagicallyOpenProcessW(&hProcess, PID);
    if (NT_SUCCESS(status)) {
        wprintf(L"Process Handle: %p\n", &hProcess);
    }
    else {
        wprintf(L"Failed to Open Process %d\n", status);
    }
    return 0;
}