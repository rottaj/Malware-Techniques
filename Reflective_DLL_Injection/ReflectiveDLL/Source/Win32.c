//
// Created by j4ck on 3/3/24.
//
#include <windows.h>
#include <winternl.h>
#include <wchar.h>
#include "../Include/Win32.h"

// Returns module handle for DLL that is loaded in executing process.
HMODULE GetModuleHandleWd(LPWSTR lpModuleName) {
    // Get PPEB
    PPEB pPeb = (PPEB)__readgsqword(0x60);
    PPEB_LDR_DATA		    pLdr	= (PPEB_LDR_DATA)(pPeb->Ldr);
    PLDR_DATA_TABLE_ENTRY	pDte	= (PLDR_DATA_TABLE_ENTRY)(pLdr->InMemoryOrderModuleList.Flink);
    while (pDte) {
        if (pDte->FullDllName.Buffer == 0) {
            break;
        }
        wprintf(L"[+] %ls\n", pDte->FullDllName.Buffer);

        if (wcsncmp(lpModuleName, pDte->FullDllName.Buffer, pDte->FullDllName.Length / sizeof(WCHAR)) == 0) {
            // Reserved[0] (InInitializationOrderLinks.Flink) is the base address of the DLL.
            return (HMODULE)pDte->Reserved2[0];
        }

        pDte = *(PLDR_DATA_TABLE_ENTRY*)(pDte); // TODO how does this work exactly
    }

    return NULL;
}

PVOID GetProcAddressWd(HMODULE hModule, LPCSTR lpProcName) {
    PIMAGE_DOS_HEADER pDosHeader = (PIMAGE_DOS_HEADER)hModule;
    if (pDosHeader->e_magic != IMAGE_DOS_SIGNATURE) {
        wprintf(L"[!] DOS Signature Failed\n");
        return NULL;
    }
    PIMAGE_NT_HEADERS pNtHeaders = (PIMAGE_NT_HEADERS)((PVOID)hModule + pDosHeader->e_lfanew);
    if (pNtHeaders->Signature != IMAGE_NT_SIGNATURE) {
        wprintf(L"[!] NT Signature Failed\n");
        return NULL;
    }
    PIMAGE_OPTIONAL_HEADER pImgOptionalHeader = (PIMAGE_OPTIONAL_HEADER)&pNtHeaders->OptionalHeader;
    PIMAGE_EXPORT_DIRECTORY pImgExportDir = (PIMAGE_EXPORT_DIRECTORY)((PVOID)hModule + pImgOptionalHeader->DataDirectory[IMAGE_DIRECTORY_ENTRY_EXPORT].VirtualAddress);

    PDWORD functionNameArray 	= (PDWORD)((PVOID)hModule + pImgExportDir->AddressOfNames);
    PDWORD addressOfFunctions 	= (PDWORD)((PVOID)hModule + pImgExportDir->AddressOfFunctions);

    for (int i=0; i<=pImgExportDir->NumberOfFunctions; i++) {
        CHAR* pFunctionName		= (CHAR*)((PVOID)hModule + functionNameArray[i]);
        if (strcmp(pFunctionName, lpProcName) == 0)  {
            return (PVOID)((PVOID)hModule + addressOfFunctions[i]);
        }
    }
    return NULL;
}
