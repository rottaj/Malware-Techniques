#include <wchar.h>
#include <stdio.h>
#include <windows.h>
#include "LoadLibrary.h"

int wmain(int argc, wchar_t* argv[]) {
    wprintf(L"%s %s\n", argv[1], argv[2]); // Where arguments are: PID & DLL Path

    HANDLE hFile = NULL;
    HANDLE hProcess = NULL;
    DWORD dwFileSize = 0;
    LPVOID lpBuffer = NULL;
    DWORD dwBytesRead = 0;
    DWORD PID = 0;

    PID = _wtoi(argv[2]);

    // Open DLL File
    hFile = CreateFileW(argv[1], GENERIC_ALL, 0, NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, NULL);
    if (hFile == NULL) {
        wprintf(L"Failed to Open File %d\n", GetLastError());
        return -1;
    }
    // Get DLL File Size
    dwFileSize = GetFileSize(hFile, NULL);
    if (dwFileSize == 0) {
        wprintf(L"Failed to Get File Size %d\n", GetLastError());
        return -1;       
    }

    // Allocate Temporary Buffer for File 

    lpBuffer = HeapAlloc(GetProcessHeap(), 0, dwFileSize);
    if (lpBuffer == NULL) {
        wprintf(L"Failed to Get Allocate Heap %d\n", GetLastError());
        return -1;       
    }

    wprintf(L"LPBUFFER: %p\n", lpBuffer);
    getchar();

    // Read File Into Buffer
    if (!ReadFile(hFile, lpBuffer, dwFileSize, &dwFileSize, NULL)) {
        wprintf(L"Failed To Read File Into Buffer %d\n", GetLastError());
        return -1;       
    }

    // Open Remote Process by PID
    hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, PID);
    if (hProcess == NULL) {
        wprintf(L"Failed To Open Remote Process %d\n", GetLastError());
        return -1;  
    }

    // Load DLL Into Remote Process
    LoadLibraryR(hProcess, lpBuffer, dwFileSize);

    getchar();
    
}