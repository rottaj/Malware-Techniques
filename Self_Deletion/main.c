//
// Created by j4ck on 1/24/24.
//
#include <windows.h>
#include <wchar.h>
#include <stdio.h>
#include <intrin.h>

#define NEW_STREAM L":Foobar"


int wmain() {
    HANDLE hFile = NULL;

    wchar_t* newFileName = L"deletion.exe:$Foobar";

    FILE_RENAME_INFO pRename = {};

    FILE_DISPOSITION_INFO pDelete = {};

    pDelete.DeleteFile = TRUE;

    size_t sRename = sizeof(FILE_RENAME_INFO) + (wcslen(newFileName) * sizeof(wchar_t));

    wcscpy(pRename.FileName, newFileName);


    hFile = CreateFileW(
        L"deletion.exe",
        DELETE | SYNCHRONIZE,
        FILE_SHARE_READ,
        NULL,
        OPEN_EXISTING,
        0,
        NULL
    );

    if (hFile == INVALID_HANDLE_VALUE) {
        wprintf(L"CreateFileW 1 Failed with Error: %d", GetLastError());
        return -1;
    }
    wprintf(L"Opened File Handle.\n");

    if (!SetFileInformationByHandle(
            hFile,
            FileRenameInfo,
            &pRename,
            sRename
            )) {

       wprintf(L"SetFileInformationByHandle Failed to Change File name %d", GetLastError());
       return -1;
    };

    wprintf(L"Changed Filename!\n");
    CloseHandle(hFile);
/*
    hFile = CreateFileW(
            L"deletion.exe:$Foobar",
            DELETE | SYNCHRONIZE,
            FILE_SHARE_READ,
            NULL,
            OPEN_EXISTING,
            0,
            NULL
    );
    if (hFile == INVALID_HANDLE_VALUE) {
        wprintf(L"CreateFileW 2 Failed with Error: %d", GetLastError());
        return -1;
    }

    // Delete file
    if (!SetFileInformationByHandle(
            hFile,
            FileDispositionInfo,
            &pDelete,
            sizeof(pDelete)
            )) {
       wprintf(L"SetFileInformationByHandle Failed to Delete File %d", GetLastError()) ;
       return -1;
    }



    CloseHandle(hFile);
    */

    getchar();
    return 0;
}