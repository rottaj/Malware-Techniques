#define _CRT_SECURE_NO_WARNINGS
#include <windows.h>
#include <stdio.h>


// Arguments: PID to Inject, Path to DLL
int wmain(int argc, wchar_t* argv[]) {
	if (argc != 3) {
		wprintf(L"Insufficient arguments passed\n");
		return 1;
	}
	DWORD PID;

	WCHAR PATH[MAX_PATH];


	LPVOID pLoadLibraryW = NULL;

	LPVOID lpBuffer = NULL;

	DWORD dwPathSize = NULL;


	PID = _wtoi(argv[1]);
	wcscpy(PATH, argv[2]);

	dwPathSize = wcslen(PATH) * sizeof(WCHAR);
	
	HANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, PID);
	if (hProcess == NULL) {
		wprintf(L"Failed to create process handle %d", GetLastError());
		return 1;
	}
	pLoadLibraryW = GetProcAddress(GetModuleHandle(L"kernel32.dll"), "LoadLibraryW");
	if (pLoadLibraryW == NULL) {
		wprintf(L"Failed to get LoadLibrary Address \n");
		return 1;
	}

	lpBuffer = VirtualAllocEx(hProcess, NULL, dwPathSize, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);

	wprintf(L"Allocated Buffer %p", lpBuffer);

	size_t lpBytesWritten = NULL;

	WriteProcessMemory(hProcess, lpBuffer, PATH, dwPathSize, &lpBytesWritten);

	HANDLE hThread = CreateRemoteThread(hProcess, NULL, NULL, (LPTHREAD_START_ROUTINE)pLoadLibraryW, lpBuffer, NULL, NULL);

	getchar();
}
