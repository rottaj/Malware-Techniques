//
// Created by j4ck on 3/6/24.
//
#include <windows.h>
#include <winternl.h>
#include <stdio.h>
#include <fcntl.h>
#include "Include/Utils.h"
#include "Include/Ldr.h"


VOID PayloadFunction() {
    MessageBoxA(NULL, "Foo", "Bar", MB_OK | MB_ICONINFORMATION);
}

BOOL APIENTRY DllMain(HMODULE hModule, DWORD dwReason, LPVOID lpReserved) {

    switch (dwReason) {
        case DLL_PROCESS_ATTACH:
            PayloadFunction();
            break;
        case DLL_THREAD_ATTACH:
        case DLL_THREAD_DETACH:
        case DLL_PROCESS_DETACH:
            break;
    }
    return TRUE;
}

/* Can't use any global variables or WinAPI functions */
extern __declspec(dllexport) BOOL ReflectiveFunction() {

    LDR_INSTANCE Instance = { 0 };

    UINT_PTR uTmpAddress = 0;
    UINT_PTR uReflectiveDllModule;
    PIMAGE_DOS_HEADER pImgDosHeader;

    Instance.Win32._vsnprintf           = (fn_vsnprintf)GetProcAddressH(GetModuleHandleH(kernel32dll_CRC32), vsnprintf_CRC32);
    Instance.Win32._HeapAlloc           = (fnHeapAlloc)GetProcAddressH(GetModuleHandleH(kernel32dll_CRC32), HeapAlloc_CRC32);
    Instance.Win32._HeapFree            = (fnHeapFree)GetProcAddressH(GetModuleHandleH(kernel32dll_CRC32), HeapFree_CRC32);
    Instance.Win32._OutputDebugString   = (fnOutputDebugString) GetProcAddressH(GetModuleHandleH(kernel32dll_CRC32), OutputDebugString_CRC32);
    Instance.Win32._GetProcessHeap      = (fnGetProcessHeap)GetProcAddressH(GetModuleHandleH(kernel32dll_CRC32), GetProcessHeap_CRC32);
    Instance.Win32._GetStdHandle        = (fnGetStdHandle )GetProcAddressH(GetModuleHandleH(kernel32dll_CRC32), GetStdHandle_CRC32);
    Instance.Win32._fdopen              = (fn_fdopen)GetProcAddressH(GetModuleHandleH(msvcrtdll_CRC32), _fdopen_CRC32);
    Instance.Win32._open_osfhandle      = (fn_open_osfhandle)GetProcAddressH(GetModuleHandleH(msvcrtdll_CRC32), _open_oshandle_CRC32);
    Instance.Win32._setvbuf             = (fnsetvbuf )GetProcAddressH(GetModuleHandleH(msvcrtdll_CRC32), setvbuf_CRC32);
    Instance.Win32._AllocConsole        = (fnAllocConsole)GetProcAddressH(GetModuleHandleH(kernel32dll_CRC32), AllocConsole_CRC32);




    // Brute forcing ReflectiveDllLdr.dll's base address, starting at ReflectiveFunction's address
    uTmpAddress = (ULONG_PTR)ReflectiveFunction;

    do
    {
        pImgDosHeader = (PIMAGE_DOS_HEADER)uTmpAddress;

        // Check if the current uTmpAddress is a DOS header
        if (pImgDosHeader->e_magic == IMAGE_DOS_SIGNATURE)
        {
            // To terminate false positives - we do another check by retrieving the NT header and checking its signature as well
            Instance.PE_HDRS.pNtHeaders = (PIMAGE_NT_HEADERS)(uTmpAddress + pImgDosHeader->e_lfanew);

            if (Instance.PE_HDRS.pNtHeaders->Signature == IMAGE_NT_SIGNATURE) {
                // If valid, the current uTmpAddress is ReflectiveDllLdr.dll's base address
                uReflectiveDllModule = uTmpAddress;
                break;
            }
        }
        // Keep decrementing to reach the DLL's base address
        uTmpAddress--;

    } while (TRUE);


    return TRUE;
}

/*
    // TODO implement DebugPrintf Try and get a print
    // TODO implement DebugPrintf Try and get a print
    // TODO implement DebugPrintf
    // TODO implement DebugPrintf (Investigate why console is not opening)
    //INT CallbackSize = Instance.Win32._vsnprintf(NULL, 0, test, 0);
    //PVOID CallbackOutput = Instance.Win32._HeapAlloc(CallbackSize);


    Instance.Win32._AllocConsole();

    // Setup Standard Output
    HANDLE handle_out = Instance.Win32._GetStdHandle(STD_OUTPUT_HANDLE);
    int hCrt = Instance.Win32._open_osfhandle((long) handle_out, _O_TEXT);
    FILE* hf_out = Instance.Win32._fdopen(hCrt, w);
    Instance.Win32._setvbuf(hf_out, NULL, _IONBF, 1);

    /*
    *stdout = *hf_out;
    */

// Setup Standard Input
/*
HANDLE handle_in = Instance.Win32._GetStdHandle(STD_INPUT_HANDLE);
hCrt = Instance.Win32._open_osfhandle((long) handle_in, _O_TEXT);
FILE* hf_in = Instance.Win32._fdopen(hCrt, "r");
Instance.Win32._setvbuf(hf_in, NULL, _IONBF, 128);
*stdin = *hf_in;
*/